
# IW4MAdmin
### Инструкция по использованию
### Версия 2.3
_______
### Об инструменте
**IW4MAdmin** - это инструмент администрирования серверов для [IW4x](https://iw4xcachep26muba.onion.link/), [Pluto T6](https://forum.plutonium.pw/category/33/plutonium-t6), [CoD4x](https://cod4x.me/), [TeknoMW3](https://www.teknomw3.pw/), и большинства выделенных серверов Call of Duty®. Он позволяет полностью контролировать ваш сервер; от смены карт и до бана игроков, **IW4MAdmin** мониторит и регистрирует активность на ваших сервереах с отображением происходящего на веб-интерфейсе в режиме реального времени. Благодаря поддержке плагинов его функциональность расширяется подобно легкому бризу..
### Скачать
Последние двоичные сборки всегда доступны по адресу:
- [RaidMax](https://raidmax.org/IW4MAdmin)  
- [GitHub](https://github.com/RaidMax/IW4M-Admin/releases)

---
### Подготовка
**IW4MAdmin** требует минимальных усилий, чтобы начать работу.
#### Предпосылки  
* [.NET Core 2.2.2 Runtime](https://www.microsoft.com/net/download) *или новее*  
#### Установка
1. Установите .NET Core Runtime
2. Распакуйте `IW4MAdmin-<version>.zip`
#### Запуск
Windows
1. Запустить StartIW4MAdmin.cmd
2. Настроить **IW4MAdmin**

Linux
1. Выполнить chmod +x StartIW4MAdmin.sh
2. Запустить StartIW4MAdmin.sh
3. Настроить **IW4MAdmin**

### Обновление
1. Загрузите последнюю версию **IW4MAdmin**
2. Извлеките более новую версию **IW4MAdmin** в существующую папку **IW4MAdmin** и перезапишите существующие файлы

_Ваша конфигурация и база данных будут сохранены_

---
### Помогите
Не стесняйтесь присоединиться к **IW4MAdmin** [Discord](https://discord.gg/ZZFK5p3)  
Если вы столкнулись с проблемой, ошибкой или запросом функции, пожалуйста, [опубликуйте проблему](https://github.com/RaidMax/IW4M-Admin/issues)
___

### Конфигурация
#### Базовая конфигурация
Когда **IW4MAdmin** запускается в _первый раз_, вам будет предложено настроить вашу конфигурацию.

`Включить веб-интерфейс`
* Позволяет монторить и контролировать ваши серверы через веб-интерфейс [по умолчанию `http://127.0.0.1:1624`]

`Включить поддержку нескольких владельцев`
* Позволяет назначать более одного клиента на уровень `Owner`
* По умолчанию &mdash; `false`

`Включить последовательную иерархию прав`
* Позволяет привилегированным клиентам назначать других клиентов до уровня коротый ниже их текущего уровня
* По умолчанию &mdash; `false`

`Включить серверное имя для чата`
* Показывает префикс для каждого сообщения отправленного **IW4MAdmin** -- `[Admin] message`
* _Эта функция требует указания пользовательского имени_
* По умолчанию &mdash; `false`

`Отображать социальную ссылку`
* Показывает ссылку на социальные сети/веб-сайт вашего сообщества в Интернете.
* По умолчанию &mdash; `false`

`Использовать иную кодировку текста`
* Позволяет использовать альтернативные кодировки для разбора игровой информации и событий
* **Русскоязычные пользователи для отображения кириллицы должны использовать это и указать** `windows-1251` **в качестве кодировки текста**
* По умолчанию &mdash; `false`

#### Конфигурация сервера
После завершения начальной настройки вам будет предложено настроить серверы для **IW4MAdmin**.

`Введите IP сервера`
* Почти для всех сценариев `127.0.0.1` подходит
* По умолчанию &mdash; `n/a`

`Введите порт сервера`
* Порт, который прослушивает ваш сервер (может быть получен через `net_port`)
* По умолчанию &mdash; `n/a`

`Введите RCon пароль сервера`
* RCon пароль нужно предварительно установить в конфигурации сервера (может быть получен с помощью `rcon_password`)
* По умолчанию &mdash; `n/a`

`Введите число резервных слотов`
* Количество клиентских слотов, зарезервированных для привилегированных игроков (недоступно для обычных пользователей)
* Например, если вы введете **2** зарезервированных слота на сервере с **18** слотами, у вас будет **16** общедоступных слотов.
* По умолчанию &mdash; `0`

#### Расширенная настройка
Если вы хотите дополнительно настроить работу **IW4MAdmin** то следующие файлы конфигурации позволят вам изменить основные параметры с помощью любого текстового редактора.

#### `IW4MAdminSettings.json`-- _этот файл создается после начальной настройки_
* Этот файл имеет расширение [JSON](https://en.wikipedia.org/wiki/JSON#JSON_sample), поэтому пожалуйста проверьте его перед запуском **IW4MAdmin**

`WebfrontBindUrl`
* Указывает адрес и порт, которые будут показывать веб-интерфейс.
* Значение может быть [IP-адрес](https://en.wikipedia.org/wiki/IP_address):порт или [Доменное имя](https://en.wikipedia.org/wiki/Domain_name):порт
* Например http://gameserver.com:8080
* По умолчанию &mdash; `http://0.0.0.0:1624` (указывает, что будут прослушиваться все IP-адреса, доступные для интерфейса по умолчанию)

`CustomLocale`
* Указывает [имя локали](https://msdn.microsoft.com/en-us/library/39cwe7zf.aspx) которое будет использоваться вместо системного по умолчанию
* Локаль должна быть из `Equivalent Locale Name` столбца
* По умолчанию &mdash; `windows-1252`

`ConnectionString`
* Определяет [строку подключения](https://www.connectionstrings.com/mysql/) к серверу MySQL, который используется вместо SQLite
* По умолчанию &mdash; `null`

`DatabaseProvider`
* Определяет провайдера базы данных, который должен использовать **IW4MAdmin**
* Возможные значения &mdash; `sqlite`, `mysql`, `postgresql`
* По умолчанию &mdash; `sqlite`

`Ignore Bots`
* Отключает ботов от регистрации и отслеживания **IW4MAdmin**

`RConPollRate`
* Указывает (в миллисекундах), как часто следует опрашивать каждый сервер на наличие обновлений
* По умолчанию &mdash; `5000`

`Servers`
* Задает список серверов для мониторинга в **IW4MAdmin**
* По умолчанию &mdash; `[]`
* `IPAddress`
	* Указывает IP-адрес конкретного сервера
	* По умолчанию &mdash; `n/a`
* `Port`
	* Указывает порт конкретного сервера
	* По умолчанию &mdash; `n/a`
* `Password`
	* Указывает `rcon_пароль` конкретного сервера
	* По умолчанию &mdash; `n/a`
* `ManualLogPath`
    * Указывает путь к логу, который будет использоваться вместо сгенерированного автоматически
    * Чтобы использовать `GameLogServer`, путь должен быть установлен в адрес http который прослушивает `GameLogServer`
    * Например &mdash; http://gamelogserver.com/
    * По умолчанию &mdash; `null`
* `AutoMessages`
	* Задает список сообщений передаваемых на конкретный сервер
	* По умолчанию &mdash; `[]`
* `Rules`
	* Задает список правил для конкретного сервера
	* По умолчанию &mdash; `[]`
* `ReservedSlotNumber`
    * Определяет количество клиентских слотов, резервируемых для привилегированных пользователей 
    * По умолчанию &mdash; `0`	
* `GameLogServerUrl`
    * Указывает URL-адрес HTTP для лога игрового сервера
    * Default &mdash; `null`	
	
`AutoMessagePeriod`
* Определяет период (в секундах), как часто сообщения должны транслироваться на каждый сервер
* По умолчанию &mdash; `60`

`AutoMessages`
* Задает список сообщений которые транслируются на **все** сервера
* Специально отформатированные **токены** могут использоваться для трансляции динамической информации:  
* `{{TOTALPLAYERS}}` &mdash; показывает сколько игроков подключено
* `{{TOPSTATS}}` &mdash; отображает 5 лучших игроков на сервере в зависимости от производительности
* `{{MOSTPLAYED}}` &mdash; отображает 5 лучших игроков в зависимости от количества убийств
* `{{TOTALPLAYTIME}}` &mdash; отображает совокупное игровое время (в человеко-часах) на всех отслеживаемых серверах
* `{{VERSION}}` &mdash; отображает версию **IW4MAdmin**
* `{{ADMINS}}` &mdash; отображает подключенных в данный момент без `масок` привилегированных пользователей онлайн
* `{{NEXTMAP}}` &mdash; отображает следующую карту и тип игры в ротации

`GlobalRules`
* Задает список правил применимых ко **всем** серверам

`Maps`
* Задает список карт для каждой поддерживаемой игры
* `Name`
	* Указывает имя карты возвращаемой игрой (обычно это имя файла без его расширения)
* `Alias`
	* Указывает отображаемое имя карты (как видно при загрузке)
___

### Команды
|Полное Имя              |Короткое|Описание                                                                               |Надобность цели|Синтаксис           |Требуемый уровень|
|--------------| -----| --------------------------------------------------------| -----------------| -------------| ----------------|
|prune|pa|разжаловать любых администраторов, которые не подключались в последнее время (по умолчанию - 30 дней)|Нет|!pa \<опционально неактивные дни\>|Owner|
|quit|q|выход с IW4MAdmin|Нет|!q |Owner|
|rcon|rcon|отправить rcon команду на сервер|Нет|!rcon \<команда\>|Owner|
|ban|b|навсегда забанить игрока на сервере|Да|!b \<игрок\> \<причина\>|SeniorAdmin|
|unban|ub|разбанить игрока по ID в базе данных|Да|!ub \<ID в базе данных\> \<причина\>|SeniorAdmin|
|find|f|найти игрока в базе данных|Нет|!f \<игрок\>|Administrator|
|killserver|kill|отключить игровой сервер|Нет|!kill |Administrator|
|map|m|изменить на указанную карту|Нет|!m \<карта\>|Administrator|
|maprotate|mr|загрузка следующей карты по ротации|Нет|!mr |Administrator|
|plugins|p|просмотреть все загруженные плагины|Нет|!p |Administrator|
|tempban|tb|временно забанить игрока на указанное время (по умолчанию - 1 час) (мин\|ч\|дни\|нед\|годы)|Да|!tb \<игрок\> \<продолжительность (m\|h\|d\|w\|y)\> \<причина\>|Adminisrator|
|alias|known|получить прошлые псевдонимы и ips игрока|Да|!known \<игрок\>|Moderator|
|baninfo|bi|получить информацию о бане игрока|Да|!bi \<игрок\>|Moderator|
|fastrestart|fr|быстрая перезагрузка текущей карты|Нет|!fr |Moderator|
|flag|fp|отметить подозрительного игрока и объявить админам о его присоединении|Да|!fp \<игрок\> \<причина\>|Moderator|
|kick|k|исключить игрока по имени|Да|!k \<игрок\> \<причина\>|Moderator|
|list|l|список активных клиентов|Нет|!l |Moderator|
|mask|hide|скрыть свое присутствие в качестве администратора|Нет|!hide |Moderator|
|reports|reps|получить или очистить последние жалобы|Нет|!reps \<опционально clear\>|Moderator|
|say|s|широковещательное сообщение всем игрокам|Нет|!s \<сообщение\>|Moderator|
|setlevel|sl|назначить игрока на указанный уровень администрирования|Да|!sl \<игрок\> \<уровень\>|Moderator|
|setpassword|sp|установить пароль для аутентификации|Нет|!sp \<пароль\>|Moderator|
|unflag|uf|Удалить флаг с клиента|Да|!uf \<player\>|Moderator|
|uptime|up|получить текущее время выполнения приложения|Нет|!up |Moderator|
|usage|us|получить использование памяти приложения|Нет|!us |Moderator|
|warn|w|предупредить игрока о нарушении правил|Да|!w \<игрок\> \<причина\>|Trusted|
|warnclear|wc|удалить все предупреждения для игрока|Да|!wc \<игрок\>|Trusted|
|admins|a|список подключенных администраторов на сервере|Нет|!a |User|
|getexternalip|ip|просмотр внешнего IP-адреса|Нет|!ip |User|
|help|h|список всех доступных команд|Нет|!h \<опционально команда\>|User|
|nextmap|nm|смотреть следующую карту в ротации|Нет|!nm |User|
|owner|iamgod|заявить право собственности на сервер|Нет|!iamgod |User|
|ping|pi|получить пинг игрока|Нет|!pi \<опционально игрок\>|User|
|privatemessage|pm|отправить приватное сообщение игроку|Да|!pm \<игрок\> \<сообщение\>|User|
|report|rep|отправить жалобу на игрока|Да|!rep \<игрок\> \<жалоба\>|User|
|rules|r|список правил сервера|Нет|!r |User|
|setgravatar|sg|установить граватар для профиля веб-интерфейса|Нет|!sg \<gravatar email\>|User|
|whoami|who|получить информацию о себе.|Нет|!who |User|

_Эти команды включают в себя все подгруженые команды плагинов._

---

#### Идентификация игрока
Все игроки идентифицируются 5ю отдельными способами   
1. `npID/GUID/XUID` - Идентификатор соответствующий игровому оборудованию или учетной записи форума  
2. `IP` - IP-адрес игрока   
3. `Client ID` - Внутренняя ссылка на игрока, сгенерированная **IW4MAdmin**   
4. `Name` - Видимое имя игрока, как оно показывется в игре 
5. `Client Number` - Слот, который клиент занимает на сервере (число колеблется от 0 до максимального количества клиентов, разрешенных на сервере)

Для большинства команд игроки идентифицируются по их `Name`.  
Однако, если они в настоящее время находятся в оффлайн, или их имя содержит непечатаемые символы то необходимо использовать их `Client ID` 

`Client ID` задается с помощью префикса и номера ссылки на игрока `@`.  
Например: `@123` это ссылка на игрока `Client ID` которого будет 123.  

**Все команды, которые нуждаются в `цели` ссылаются на `первый аргумент` в форме идентификации игрока**

---

#### Дополнительные примеры команд
`setlevel`
- _Ярлык_ - `sl`
- _Параметр 1_ - Игрок для изменения уровня
- _Параметр 2_ - Уровень, чтобы установить игроку на ```[ User, Trusted, Moderator, Administrator, SeniorAdmin, Owner ]```
- _Пример _ - `!setlevel Игрок1 SeniorAdmin`, `!sl @123 Moderator`
- **ПРИМЕЧАНИЕ** - Невозможно установить уровень другого игрока на `owner` если параметр `поддержка нескольких владельцев` в конфигурации не включен во время настройки

`ban`
- _Ярлык_ - `b`
- _Параметр 1_ - Игрок для бана
- _Параметр 2_ - Причина бана
- _Пример_ - `!ban Игрок1 Замечен читинг`, `!b @123 Подмена GUID`

`tempban`
- _Ярлык_ - `tb`
- _Параметр 1_ - Игрок для бана
- _Параметр 2_ - Длительность бана (m-минуты|h-часы|d-дни|w-недели|y-годы)
- _Параметр 3_ - Причина бана
- _Пример_ - `!tempban Игрок1 3w расизм`, `!tb @123 8h Оскорбительное поведение`

`reports`  
- _Ярлык_ - `reps`
- _Опциональный параметр 1_ - `clear` (очищает жалобы для текущего сервера)

___
### Плагины

#### Приветствие   
- Этот плагин использует геоданные, чтобы приветствовать игрока в зависимости от его страны происхождения
- Все привилегированные пользователи (доверенные или выше) также получают специализированное приветственное сообщение
- Приветственные сообщения могут быть настроены в `WelcomePluginSettings.json`

#### Статистика
- Этот плагин вычисляет базовую производительность игрока, приближение навыка и коэффициент убийства/смерти 
- Skill - это число полученное из алгоритмической обработки коэффициента убийств игрока (KDR) и показателя в минуту (SPM)
- Elo - рейтинг основан на количестве встреч которые выигрывает игрок.
- Производительность - это средняя оценка из рейтингов Skill + Elo



**Команды, добавленные этим плагином** 

|Полное имя              |Короткое|Описание                                                                               |Надобность цели|Синтаксис           |Требуемый уровень|
|--------------| -----| --------------------------------------------------------| -----------------| -------------| ----------------|
|resetstats|rs|сбросить свою статистику|Нет|!rs |User|
|stats|xlrstats|просмотреть свою статистику|Нет|!xlrstats \<опционально игрок\>|User|
|topstats|ts|просмотреть 5 лучших игроков на этом сервере|Нет|!ts |User|
|mostplayed|mp|просмотреть 5 лучших игроков на сервере|Нет|!mp |User|

- Чтобы претендовать на топ-статистику, клиент должен сыграть как минимум `3 часа` и подключался в течение последних `15 дней`.

#### Авторизация
- Этот плагин исключает подмену GUID, требуя чтобы привилегированные пользователи входили в систему со своим паролем перед выполнением команд
- Пароль должен быть установлен с помощью `setpassword` команды перед входом в систему

 **Команды, добавленные этим плагином**  

|Полное имя              |Короткое|Описание                                                                               |Надобность цели|Синтаксис           |Требуемый уровень|
|--------------| -----| --------------------------------------------------------| -----------------| -------------| ----------------|
|login|l|залогинится с использованием пароля|Нет|!l \<пароль\>|Trusted|

#### Ненормативная лексика
- Этот плагин предупреждает и исключает игроков за использование ненормативной лексики
- Ненормативные слова и предупреждающее сообщение указываются в `ProfanityDetermentSettings.json`
- Если имя клиента содержит слово указанное в настройках то он будет немедленно исключен

#### Команды скрипта IW4
- Этот плагин обеспечивает дополнительную интеграцию с IW4x
- Чтобы воспользоваться этим скопируйте папку `userraw` в каталог вашего сервера IW4x

#### Обнаружение VPN [Скрипт плагин]
- Этот плагин обнаруживает использует ли клиент VPN, если да то исключает его из сервера
- Чтобы отключить этот плагин удалите `Plugins\VPNDetection.js`
- Добавление **Client IDs** в `vpnExceptionIds` массив предотвратит исключение клиента

#### Shared GUID Kicker [Скрипт плагин]
- Этот плагин исключает пользователей использующих определенный GUID
- GUID `F4D2C30B712AC6E3` на IW4x был упакован в торрент-версию игры
___
### Веб-интерфейс
`Home`
* Показывает обзор отслеживаемых сервераов

`Penalties`
* Показывает хронологически упорядоченный список штрафов клиентов (прокрутка вниз загружает старые штрафы)

`Admins`
* Показывает список привилегированных клиентов

`Login`
* Позволяет привилегированным пользователям входить в систему используя их `Client ID` и пароль установленный через `setpassword`
* `ClientID` это номер который можно найти с помощью `!find <client name>` или найти клиента в веб-интерфейсе и скопировать числовой идентификатор после `ProfileAsync/`

`Profile`
* Показывает информацию и историю клиента 

`Web Console`
* Позволяет зарегистрированным привилегированным пользователям выполнять команды так если бы они были в игре
---
### Игровой лог сервера
Сервер игровых логов предоставляет способ удаленного размещения логов вашего сервера через HTTP используя API 
Этот сервер полезен если вы планируете запустить IW4MAdmin на другом компьютере, а не на игровом сервере
#### Требования
- [Python 3.6](https://www.python.org/downloads/) или новее
- Следующие пакеты [PIP](https://pypi.org/project/pip/) (предоставляются в `requirements.txt`)
 ```Flask>=1.0.2
aniso8601>=3.0.2
click>=6.7
Flask-RESTful>=0.3.6
itsdangerous>=0.24
Jinja2>=2.10
MarkupSafe>=1.0
pip>=9.0.3
pytz>=2018.5
setuptools>=39.0.1
six>=1.11.0
Werkzeug>=0.14.1
``` 
#### Installation
1. С установленным Python 3 откройте окно терминала/командной строки в `GameLogServer` папке и выполните:
    ```console
    pip install -r requirements.txt
    ```
    Если это не помогло вы можете попробовать установить:
    ```console
    python -m pip install -r requirements.txt
    ```
2. Разрешить TCP-порт 1625 через брандмауэр  
    * [Инструкция для Windows](https://www.tomshardware.com/news/how-to-open-firewall-ports-in-windows-10,36451.html)
    * [Инструкция для Linux (iptables)](https://www.digitalocean.com/community/tutorials/how-to-set-up-a-basic-iptables-firewall-on-centos-6#open-up-ports-for-selected-services)
#### Запуск  
С установленным Python 3 откройте окно терминала/командной строки в `GameServerLog` папке и выполните:
```console
python runserver.py
```
Окно Game Log Server должно оставаться запущенным/открытым пока работает **IW4MAdmin**

---
### Расширенные плагины

#### NuGet пакет
Пакет NuGet для "Общей библиотеки" **IW4MAdmin** можно получить [NuGet галерее](https://www.nuget.org/packages/RaidMax.IW4MAdmin.SharedLibraryCore)
Ссылка на этот пакет даст вам возможность писать плагины для базовой библиотеки **IW4MAdmin**
#### Код
Функциональность **IW4MAdmin** может быть расширена путем написания дополнительных плагинов на C#.  
Каждая библиотека классов должна реализовывать `IPlugin` интерфейс   
Для примера смотрите существующие [плагины](https://github.com/RaidMax/IW4M-Admin/tree/master/Plugins)
#### JavaScript
Функциональность **IW4MAdmin** также может быть расширена с помощью JavaScript
Парсер JavaScript поддеоживает стандарты [ECMA 5.1](https://ecma-international.org/ecma-262/5.1/)
#### Шаблон объекта плагина
Для правильного анализа движком JavaScript каждый плагин должен соответствовать следующему шаблону
```js
var plugin = {
    author: 'YourHandle',
    version: 1.0,
    name: 'Sample JavaScript Plugin',

    onEventAsync: function (gameEvent, server) {
    },

    onLoadAsync: function (manager) {
    },

    onUnloadAsync: function () {
    },

    onTickAsync: function (server) {
    }
};
```
#### Обязательные свойства
- `author` &mdash; [string] Автор плагина (обычно ваше имя или имя в сети/псевдоним)
- `version` &mdash; [float] Номер версии вашего плагина (полезно если вы выпускаете несколько разных версий)
- `name` &mdash; [string] Название вашего плагина (должно быть описательным!)
- `onEventAsync` &mdash; [function] Обработчик выполняется при возникновении события
    - `gameEvent` &mdash; [parameter object] Объект содержащий тип события, происхождение, цель и другую информацию (см. объявление класса GameEvent)
    - `server` &mdash; [parameter object] Объект содержащий информацию и методы о сервере на котором произошло событие (см. объявление класса сервера)
- `onLoadAsync` &mdash; [function] Обработчик выполняется когда плагин загружен кодом
    - `manager` &mdash; [parameter object] Ссылка на объект в диспетчере приложений (см. определение интерфейса IManager) 
- `onUnloadAsync` &mdash; [function] Обработчик выполняется когда плагин выгружается по коду (см. живая перезагрузка)
- `onTickAsync` &mdash; [function] Обработчик выполняется примерно один раз в секунду кодом (не реализовано начиная с версии 2.\*)*
    - `server` &mdash; [parameter object] Объект содержащий информацию и методы о сервере на котором произошло событие (см. объявление класса сервера)
### Живая перезагрузка
Благодаря гибкости и возможности разбора JavaScript импортер плагинов сканирует папку плагинов и перезагружает плагины JavaScript по мере их изменения. Это позволяет ускорить разработку/тестирование/отладку

---
### Разное
#### Анти-чит
Это единственная функция [IW4x](https://iw4xcachep26muba.onion.link/) (запланирована более широкая поддержка игр), которая использует аналитику для обнаружения прицельных ботов и вспомогательных средств прицеливания.
Для того чтобы использовать анти-чит включите его во время установки **и** скопируйте `_customcallbacks.gsc` из `GameFiles` в вашу папку сервера `IW4x Server\userraw\scripts`  

Функция защиты от мошенничества находится в стадии разработки, как таковая будет постоянно дорабатываться и возможно не будет на 100% точной, однако цель состоит в том чтобы оградить как можно больше читеров от IW4x.
#### Базы данных
Вся информация **IW4MAdmin** сохраняется в файле `Database.db`. 
Если вам нужно сбросить всю базу данных, то этот файл можно просто удалить. 
Кроме того, этот файл сохраняется во время обновлений, чтобы сохранить всю информацию о клиентах.

Настройка `ConnectionString` и `DatabaseProvider` свойств в `IW4MAdminSettings.json`  
позволит **IW4MAdmin** использовать альтернативные методы для хранения баз данных.
